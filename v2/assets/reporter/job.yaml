apiVersion: batch/v1
kind: Job
metadata:
  name: rhm-meter-report
  labels:
    marketplace.redhat.com/report: 'true'
spec:
  completions: 1
  parallelism: 1
  template:
    spec:
      serviceAccount: redhat-marketplace-operator
      restartPolicy: Never
      containers:
        - name: reporter
          image: redhat-markplace-reporter
          imagePullPolicy: Always
          env: 
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  containerName: reporter
                  resource: limits.memory
          # additional args are added in factory
          args:
            [
              'report',
              '--cafile',
              '/etc/configmaps/operator-cert-ca-bundle/service-ca.crt',
              '--tokenfile',
              '/etc/auth-service-account/token',
            ]
          runAsUser:
          volumeMounts:
            - mountPath: /etc/configmaps/operator-cert-ca-bundle
              name: operator-certs-ca-bundle
              readOnly: true
            - mountPath: /etc/auth-service-account
              name: token-vol
              readOnly: true
            - mountPath: /etc/configmaps/serving-certs-ca-bundle
              name: serving-certs-ca-bundle
              readOnly: true
      volumes:
        - configMap:
            name: operator-certs-ca-bundle
          name: operator-certs-ca-bundle
        - configMap:
            name: serving-certs-ca-bundle
          name: serving-certs-ca-bundle
        - name: token-vol
          projected:
            sources:
              - serviceAccountToken:
                  audience: rhm-prometheus-meterbase.openshift-redhat-marketplace.svc
                  expirationSeconds: 3600
                  path: token
