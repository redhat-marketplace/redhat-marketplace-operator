# Generated by internal/ci/ci_tool.cue; do not edit
name: Branch Build
on:
  push:
    branches:
    - master
    - release/**
    - hotfix/**
    - develop
    - feature/**
    - bugfix/**
env:
  IMAGE_REGISTRY: quay.io/rh-marketplace
jobs:
  test:
    name: Test
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Cancel Previous Run
      uses: styfle/cancel-workflow-action@0.4.1
      with:
        access_token: ${{ github.token }}
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16.8
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ github.sha }}
        restore-keys: ${{ runner.os }}-go-
    - name: Install Kubebuilder
      run: |-
        os=$(go env GOOS)
        arch=$(go env GOARCH)
        version=2.3.2

        # download kubebuilder and extract it to tmp
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v3.1.0/kubebuilder_darwin_amd64
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v2.3.1/kubebuilder_2.3.1_darwin_amd64.tar.gz
        # 3.0 + versions will not be tar.gz
        curl -L https://github.com/kubernetes-sigs/kubebuilder/releases/download/v${version}/kubebuilder_${version}_${os}_${arch}.tar.gz | tar -xz -C /tmp/

        # move to a long-term location and put it on your path
        # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
        sudo mv /tmp/kubebuilder_${version}_${os}_${arch} /usr/local/kubebuilder
        echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH
    - name: Test
      run: make operator/test
  matrix-test:
    name: Matrix Test
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16.8
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ github.sha }}
        restore-keys: ${{ runner.os }}-go-
    - name: Install Kubebuilder
      run: |-
        os=$(go env GOOS)
        arch=$(go env GOARCH)
        version=2.3.2

        # download kubebuilder and extract it to tmp
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v3.1.0/kubebuilder_darwin_amd64
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v2.3.1/kubebuilder_2.3.1_darwin_amd64.tar.gz
        # 3.0 + versions will not be tar.gz
        curl -L https://github.com/kubernetes-sigs/kubebuilder/releases/download/v${version}/kubebuilder_${version}_${os}_${arch}.tar.gz | tar -xz -C /tmp/

        # move to a long-term location and put it on your path
        # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
        sudo mv /tmp/kubebuilder_${version}_${os}_${arch} /usr/local/kubebuilder
        echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH
    - name: Test
      run: make ${{ matrix.project }}/test
    strategy:
      matrix:
        project:
        - authchecker
        - metering
        - reporter
        - tests
  images:
    name: Build Images
    runs-on: ubuntu-20.04
    env:
      GO_VERSION: 1.16.8
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16.8
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
      with:
        image: tonistiigi/binfmt:qemu-v6.1.0
        platforms: all
    - id: buildx
      name: Set up docker buildx
      uses: docker/setup-buildx-action@v1
      with:
        config: .github/buildkitd.toml
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ github.sha }}
        restore-keys: ${{ runner.os }}-go-
    - name: Install Kubebuilder
      run: |-
        os=$(go env GOOS)
        arch=$(go env GOARCH)
        version=2.3.2

        # download kubebuilder and extract it to tmp
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v3.1.0/kubebuilder_darwin_amd64
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v2.3.1/kubebuilder_2.3.1_darwin_amd64.tar.gz
        # 3.0 + versions will not be tar.gz
        curl -L https://github.com/kubernetes-sigs/kubebuilder/releases/download/v${version}/kubebuilder_${version}_${os}_${arch}.tar.gz | tar -xz -C /tmp/

        # move to a long-term location and put it on your path
        # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
        sudo mv /tmp/kubebuilder_${version}_${os}_${arch} /usr/local/kubebuilder
        echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: quay.io/rh-marketplace
        username: ${{secrets['quayUser']}}
        password: ${{secrets['quayPassword']}}
    - id: version
      name: Get Version
      run: |-
        make svu
        export VERSION="$(./bin/svu next --prefix '')"

        if [ "$REF" == "" ]; then
        	REF="$GITHUB_REF"
        fi

        if [[ "$GITHUB_HEAD_REF" != "" ]]; then
        	echo "Request is a PR $GITHUB_HEAD_REF is head; is base $GITHUB_BASE_REF is base"
        	REF="$GITHUB_HEAD_REF"
        fi

        echo "Found ref $REF"

        if [[ "$VERSION" == "" ]]; then
        	echo "failed to find version"
        	exit 1
        fi

        if [[ "$REF" == *"release"* ||  "$REF" == *"hotfix"* || "$REF" == *"refs/head/master"* || "$REF" == *"refs/head/develop"* ]] ; then
        echo "using release version and github_run_number"
        export VERSION=${VERSION}-${GITHUB_RUN_NUMBER}
        export TAG="${VERSION}-${GITHUB_RUN_NUMBER}"
        export IS_DEV="false"
        else
        echo "using beta in version"
        export VERSION=${VERSION}-beta.${GITHUB_RUN_NUMBER}
        export TAG="${VERSION}"
        export IS_DEV="true"
        fi

        echo "Found version $VERSION"
        echo "::set-output name=version::$VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Found tag $TAG"
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "::set-output name=tag::$TAG"
        echo "IS_DEV=$IS_DEV" >> $GITHUB_ENV
        echo "::set-output name=isDev::$IS_DEV"
        echo "REF=$REF" >> $GITHUB_ENV
    - id: build
      name: Build and push images
      run: |-
        if [ "$IS_DEV" == "true" ]; then
        	export ARCHS="amd64"
        fi

        make clean-licenses save-licenses ${{ matrix.project }}/docker-build
      env:
        DOCKERBUILDXCACHE: /tmp/.buildx-cache
        IMAGE_PUSH: "true"
    strategy:
      matrix:
        project:
        - operator
        - authchecker
        - metering
        - reporter
        - airgap
        include:
        - project: operator
        - project: authchecker
        - project: metering
        - project: reporter
        - project: airgap
  deploy:
    name: Deploy
    needs:
    - test
    - matrix-test
    - images
    runs-on: ubuntu-20.04
    outputs:
      isDev: ${{ steps.bundle.outputs.isDev }}
      version: ${{ steps.bundle.outputs.version }}
      tag: ${{ steps.bundle.outputs.tag }}
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16.8
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
      with:
        image: tonistiigi/binfmt:qemu-v6.1.0
        platforms: all
    - id: buildx
      name: Set up docker buildx
      uses: docker/setup-buildx-action@v1
      with:
        config: .github/buildkitd.toml
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ github.sha }}
        restore-keys: ${{ runner.os }}-go-
    - name: Install Kubebuilder
      run: |-
        os=$(go env GOOS)
        arch=$(go env GOARCH)
        version=2.3.2

        # download kubebuilder and extract it to tmp
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v3.1.0/kubebuilder_darwin_amd64
        # https://github.com/kubernetes-sigs/kubebuilder/releases/download/v2.3.1/kubebuilder_2.3.1_darwin_amd64.tar.gz
        # 3.0 + versions will not be tar.gz
        curl -L https://github.com/kubernetes-sigs/kubebuilder/releases/download/v${version}/kubebuilder_${version}_${os}_${arch}.tar.gz | tar -xz -C /tmp/

        # move to a long-term location and put it on your path
        # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
        sudo mv /tmp/kubebuilder_${version}_${os}_${arch} /usr/local/kubebuilder
        echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: quay.io/rh-marketplace
        username: ${{secrets['quayUser']}}
        password: ${{secrets['quayPassword']}}
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: registry.connect.redhat.com
        username: ${{secrets['REDHAT_IO_USER']}}
        password: ${{secrets['REDHAT_IO_PASSWORD']}}
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: registry.redhat.io
        username: ${{secrets['REDHAT_IO_USER']}}
        password: ${{secrets['REDHAT_IO_PASSWORD']}}
    - id: version
      name: Get Version
      run: |-
        make svu
        export VERSION="$(./bin/svu next --prefix '')"

        if [ "$REF" == "" ]; then
        	REF="$GITHUB_REF"
        fi

        if [[ "$GITHUB_HEAD_REF" != "" ]]; then
        	echo "Request is a PR $GITHUB_HEAD_REF is head; is base $GITHUB_BASE_REF is base"
        	REF="$GITHUB_HEAD_REF"
        fi

        echo "Found ref $REF"

        if [[ "$VERSION" == "" ]]; then
        	echo "failed to find version"
        	exit 1
        fi

        if [[ "$REF" == *"release"* ||  "$REF" == *"hotfix"* || "$REF" == *"refs/head/master"* || "$REF" == *"refs/head/develop"* ]] ; then
        echo "using release version and github_run_number"
        export VERSION=${VERSION}-${GITHUB_RUN_NUMBER}
        export TAG="${VERSION}-${GITHUB_RUN_NUMBER}"
        export IS_DEV="false"
        else
        echo "using beta in version"
        export VERSION=${VERSION}-beta.${GITHUB_RUN_NUMBER}
        export TAG="${VERSION}"
        export IS_DEV="true"
        fi

        echo "Found version $VERSION"
        echo "::set-output name=version::$VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Found tag $TAG"
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "::set-output name=tag::$TAG"
        echo "IS_DEV=$IS_DEV" >> $GITHUB_ENV
        echo "::set-output name=isDev::$IS_DEV"
        echo "REF=$REF" >> $GITHUB_ENV
    - id: bundle
      name: Build bundle
      run: |-
        REF=`echo ${GITHUB_REF} | sed 's/refs\/head\///g' | sed 's/\//-/g'`
        echo "building $BRANCH with dev=$IS_DEV and version=$VERSION"

        cd v2
        export TAG=$IMAGE_TAG
        echo "::group::Make Stable Bundle"
        make bundle-stable
        echo "::endgroup::"

        export VERSION=$IMAGE_TAG
        echo "::group::Make Bundle Build"
        make bundle-build
        echo "::endgroup::"
        echo "::group::Make Dev Index"
        make bundle-dev-index-multiarch
        echo "::endgroup::"

        echo "::set-output name=isDev::$IS_DEV"
        echo "::set-output name=version::$VERSION"
        echo "::set-output name=tag::$TAG"
      env:
        IMAGE_TAG: ${{ steps.version.outputs.tag }}
    - uses: actions/upload-artifact@v2
      with:
        name: release-bundle-${{ steps.bundle.outputs.tag }}
        path: v2/bundle
    - uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: devindex
        recreate: "true"
        message: |-
          Available to test on openshift using a catalogsource:

          ``` yaml
          apiVersion: operators.coreos.com/v1alpha1
          kind: CatalogSource
          metadata:
            name: rhm-test
            namespace: openshift-marketplace
          spec:
            displayName: RHM Test
            image: quay.io/rh-marketplace/redhat-marketplace-operator-dev-index:${{ env.TAG }}
            publisher: ''
            sourceType: grpc
          ```
