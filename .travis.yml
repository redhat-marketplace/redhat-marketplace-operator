# Generated by internal/ci/ci_tool.cue; do not edit

version: ~> 1.0
dist: focal
if: (type = push && (branch = master || branch = develop)) || (type = pull_request
  && (branch = master))
language: go
services:
- docker
before_script:
- go get github.com/onsi/ginkgo/ginkgo
- docker pull docker.io/docker/dockerfile:experimental
- docker pull docker.io/docker/dockerfile-copy:v0.1.9
- export VERSION=`cd v2/tools && go run ./version/main.go`-${TRAVIS_COMMIT}
- docker login -u="${ROBOT_USER_NAME}" -p="${ROBOT_PASS_PHRASE}" quay.io
go: 1.15.6
env:
  global:
  - IMAGE_REGISTRY=quay.io/rh-marketplace DOCKER_CLI_EXPERIMENTAL=enabled DOCKER_BUILDKIT=1
    QUAY_EXPIRATION=never BUILDX=false
jobs:
  include:
  - stage: push
    arch: amd64
    env: ARCH=amd64
  - stage: push
    arch: ppc64le
    env: ARCH=ppc64le
  - stage: manifest
    if: true
    env: ARCHS="amd64 ppc64le"
    script: |-
      echo "making manifest for $VERSION"
      make docker-manifest
  - stage: bundle
    if: (type = pull_request && head_branch =~ /^(master|develop|release.*|hotfix.*)$/)
      || (type = push && branch =~ /^(master|develop|release.*|hotfix.*)$/)
    script: 'curl -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json"
      https://api.github.com/repos/redhat-marketplace/redhat-marketplace-operator/dispatches
      -d "{\"event_type\":\"bundle\",\"client_payload\":{\"sha\":\"$TRAVIS_COMMIT\",\"branch\":\"$TRAVIS_BRANCH\",\"pull_request_branch\":\"$TRAVIS_PULL_REQUEST_BRANCH\",\"pull_request\":\"$TRAVIS_PULL_REQUEST\"}}"'
script:
- docker --version
- export VERSION=${VERSION}-${ARCH}
- echo  ${VERSION}
- echo "Login to Quay.io docker account..."
- |-
  echo "run tests if not s390x because kubebuilder has no binaries for it"
  if [ "$(go env GOARCH)" = "amd64" ]; then
  os=$(go env GOOS)
  arch=$(go env GOARCH)

  # download kubebuilder and extract it to tmp
  curl -L https://go.kubebuilder.io/dl/2.3.1/${os}/${arch} | tar -xz -C /tmp/

  # move to a long-term location and put it on your path
  # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
  sudo mv /tmp/kubebuilder_2.3.1_${os}_${arch} /usr/local/kubebuilder
  echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH

  export PATH=$PATH:/usr/local/kubebuilder/bin
  make operator/test-ci-unit
  fi
- echo "Building the Red Hat Marketplace operator images for ${ARCH}..."
- make docker-build
- make docker-push
- echo "Docker Image push to quay.io is done !"
